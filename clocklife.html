<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生命倒计时 | Life Countdown</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(-45deg, #2C3E50, #FD746C, #4B79A1, #283E51);
            background-size: 400% 400%;
            animation: gradient 20s ease infinite;
            min-height: 100vh;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Black Glass Panel --- */
        .glass-panel {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(51, 255, 0, 0.3);
            box-shadow: 0 0 40px rgba(51, 255, 0, 0.1);
        }

        .time-card {
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid rgba(51, 255, 0, 0.2);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease;
        }
        
        .time-card:hover {
            transform: translateY(-5px);
            border-color: rgba(51, 255, 0, 0.6);
            box-shadow: 0 0 15px rgba(51, 255, 0, 0.2);
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none; margin: 0;
        }
        
        input::-webkit-calendar-picker-indicator {
            opacity: 0.5; cursor: pointer; filter: invert(1);
        }
        input::-webkit-calendar-picker-indicator:hover { opacity: 1; }
        
        /* Text Utils */
        .text-glow-white {
            text-shadow: 0 0 2px rgba(255, 255, 255, 0.9), 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        /* Theme Colors */
        .text-theme { color: #33ff00; text-shadow: 0 0 5px rgba(51, 255, 0, 0.4); }
        .border-theme { border-color: #33ff00; }
        .bg-theme { background-color: #33ff00; }
        .placeholder-theme::placeholder { color: rgba(51, 255, 0, 0.3); }

        .bg-year-gradient {
            background: linear-gradient(90deg, #002FA7, #008C8C, #F7E14D, #81D8D0);
        }
        .bg-life-30k-gradient {
            background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%);
        }

        .font-tech {
            font-family: 'VT323', monospace;
            letter-spacing: 2px;
        }

        /* --- HEARTBEAT BAR STYLES --- */
        .hb-container {
            width: 100%;
            height: 60px;
            background: #000;
            border: 2px solid #33ff00;
            position: relative;
            box-shadow: 0 0 15px rgba(51, 255, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
        }

        .hb-fill {
            height: 100%;
            background-color: #33ff00;
            width: 0%;
            position: absolute;
            left: 0; top: 0; bottom: 0;
            z-index: 0;
            box-shadow: 0 0 20px #33ff00;
            transition: width 0.1s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }

        .hb-text {
            position: relative;
            z-index: 10;
            color: #33ff00; 
            font-weight: bold;
            mix-blend-mode: difference; 
            pointer-events: none;
            font-size: 1.5rem;
            white-space: nowrap;
        }

        .pulse-active .hb-fill {
            animation: bar-surge 0.15s ease-out;
        }
        
        .pulse-active .hb-text {
            animation: text-jolt 0.1s linear;
        }

        @keyframes bar-surge {
            0% { filter: brightness(1); transform: scaleX(1); }
            50% { filter: brightness(1.5); transform: scaleX(1.005); }
            100% { filter: brightness(1); transform: scaleX(1); }
        }

        @keyframes text-jolt {
            0% { transform: translate(0, 0); }
            25% { transform: translate(1px, 1px); }
            50% { transform: translate(-1px, 0); }
            75% { transform: translate(0, -1px); }
            100% { transform: translate(0, 0); }
        }
        
        /* New Heart Styles */
        .heart-wrapper {
            position: relative;
            width: 200px;
            height: 180px;
            filter: drop-shadow(0 0 5px #33ff00);
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
        }

        .heart-wrapper.pulse-active {
            animation: heart-beat 0.25s cubic-bezier(0.1, 0.7, 1.0, 0.1);
        }

        @keyframes heart-beat {
            0% { transform: scale(1); filter: drop-shadow(0 0 5px #33ff00); }
            40% { transform: scale(1.15); filter: drop-shadow(0 0 20px #33ff00); }
            100% { transform: scale(1); filter: drop-shadow(0 0 5px #33ff00); }
        }

        .heart-svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }

        .info-text-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            text-align: center;
            width: 100%;
            pointer-events: none;
            color: #ffffff; 
            text-shadow: 0 0 5px #000, 0 0 10px #33ff00, 2px 2px 0px #000;
        }

        .label-text { font-size: 0.8rem; opacity: 0.9; display: block; margin-bottom: 2px; letter-spacing: 1px; }
        .beat-number { font-size: 1.5rem; font-weight: bold; display: block; line-height: 1; margin-bottom: 2px; letter-spacing: 1px; }
        .percent-text { font-size: 0.8rem; display: block; opacity: 0.9; letter-spacing: 1px; }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden relative">
        <!-- Home Button (Top Left) - Dynamic Link -->
        <a href="#" onclick="goHome(event)" class="absolute top-4 left-4 text-theme opacity-60 hover:opacity-100 transition-opacity z-50 p-2">
            <i class="fas fa-home text-2xl"></i>
        </a>

        <!-- Help Button (Top Right) -->
        <button onclick="toggleHelp()" class="absolute top-4 right-4 text-theme opacity-60 hover:opacity-100 transition-opacity z-50 p-2">
            <i class="fas fa-question-circle text-2xl"></i>
        </button>

        <!-- Help Modal -->
        <div id="help-modal" class="hidden absolute inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 transition-all duration-300">
            <div class="bg-gray-900 border border-[#33ff00] p-6 rounded-2xl max-w-md w-full shadow-[0_0_30px_rgba(51,255,0,0.2)] relative">
                <!-- Close Button -->
                <button onclick="toggleHelp()" class="absolute top-4 right-4 text-gray-500 hover:text-[#33ff00] transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
                
                <h3 class="text-2xl font-bold text-theme mb-4 font-tech tracking-wide border-b border-gray-800 pb-2">
                    <i class="fas fa-info-circle mr-2"></i>关于本站
                </h3>
                
                <div class="text-gray-300 space-y-4 text-sm leading-relaxed mb-6 font-mono">
                    <p>
                        <span class="text-theme font-bold">aoao生命倒计时</span> 是一个基于“人生只有 30,000 天”概念的可视化工具。
                    </p>
                    <p>
                        假设人类平均寿命为 80 岁，心脏大约跳动 30 亿次。我们通过实时模拟心跳和进度条，将抽象的时间流逝具象化。
                    </p>
                    <p class="text-xs opacity-70 border-l-2 border-theme pl-3">
                        * 数据仅保存在您的本地浏览器中，不会上传到任何服务器。
                    </p>
                </div>

                <div class="border-t border-gray-800 pt-4">
                    <h4 class="text-sm font-bold text-theme mb-2 uppercase tracking-widest">联系方式 / Contact</h4>
                    <p class="text-gray-400 text-sm">
                        邮箱：<span class="text-white select-all hover:text-theme transition-colors cursor-pointer">x@emusk.cn</span>
                    </p>
                    <p class="text-gray-400 text-sm mt-1">
                        Twitter：<span class="text-white select-all hover:text-theme transition-colors cursor-pointer">@aoaodotlife</span>
                    </p>
                    <div class="mt-3 flex space-x-4">
                        <a href="https://aoao.life" target="_blank" class="text-gray-400 text-sm hover:text-theme transition-colors underline decoration-dotted">aoao.life</a>
                        <a href="https://emusk.cn" target="_blank" class="text-gray-400 text-sm hover:text-theme transition-colors underline decoration-dotted">emusk.cn</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="relative z-10 p-8 md:p-12">
            
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 id="main-title" class="text-3xl md:text-5xl font-bold text-theme mb-3 tracking-tight">
                    生命倒计时
                </h1>
                <!-- Subtitle updated to show Today's Date -->
                <p id="sub-title" class="text-theme text-lg font-medium opacity-90"></p>
            </div>

            <!-- Setup Form Section -->
            <div id="setup-section" class="transition-all duration-500 ease-in-out">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="relative group">
                        <label class="block text-theme text-sm font-semibold mb-2 ml-1">您的姓名</label>
                        <div class="flex items-center bg-gray-900 rounded-xl border-2 border-transparent focus-within:border-[#33ff00] focus-within:bg-black transition-all shadow-sm">
                            <span class="pl-4 text-theme opacity-70"><i class="fas fa-user"></i></span>
                            <input type="text" id="name-input" placeholder="请输入您的名字" 
                                class="w-full p-4 bg-transparent outline-none text-theme font-medium rounded-xl placeholder-theme" value="">
                        </div>
                    </div>
                    <div class="relative group">
                        <label class="block text-theme text-sm font-semibold mb-2 ml-1">出生日期</label>
                        <div class="flex space-x-2">
                            <div class="relative flex-[1.4] bg-gray-900 rounded-xl border-2 border-transparent focus-within:border-[#33ff00] focus-within:bg-black transition-all shadow-sm">
                                <input type="number" id="year-input" list="year-list" placeholder="年份" min="1900" max="2100" class="w-full p-4 bg-transparent outline-none text-theme font-medium rounded-xl pr-2 placeholder-theme">
                                <datalist id="year-list"></datalist>
                                <div class="absolute right-8 top-1/2 transform -translate-y-1/2 text-theme opacity-70 pointer-events-none text-xs font-bold">年</div>
                            </div>
                            <div class="relative flex-1 bg-gray-900 rounded-xl border-2 border-transparent focus-within:border-[#33ff00] focus-within:bg-black transition-all shadow-sm">
                                <input type="number" id="month-input" list="month-list" placeholder="月" min="1" max="12" class="w-full p-4 bg-transparent outline-none text-theme font-medium rounded-xl pr-2 placeholder-theme">
                                <datalist id="month-list"></datalist>
                                <div class="absolute right-8 top-1/2 transform -translate-y-1/2 text-theme opacity-70 pointer-events-none text-xs font-bold">月</div>
                            </div>
                            <div class="relative flex-1 bg-gray-900 rounded-xl border-2 border-transparent focus-within:border-[#33ff00] focus-within:bg-black transition-all shadow-sm">
                                <input type="number" id="day-input" list="day-list" placeholder="日" min="1" max="31" class="w-full p-4 bg-transparent outline-none text-theme font-medium rounded-xl pr-2 placeholder-theme">
                                <datalist id="day-list"></datalist>
                                <div class="absolute right-8 top-1/2 transform -translate-y-1/2 text-theme opacity-70 pointer-events-none text-xs font-bold">日</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 border border-[#33ff00] border-opacity-30 p-4 rounded-xl mb-6 text-sm text-theme flex items-start">
                    <i class="fas fa-info-circle mt-1 mr-2 opacity-80"></i>
                    <!-- Modified Text Here -->
                    <p>您的数据保存在您的本地浏览器，服务器无法记录。</p>
                </div>

                <button onclick="startLifeCountdown()" 
                    class="w-full bg-[#33ff00] hover:bg-green-400 text-black font-bold py-4 px-6 rounded-xl shadow-[0_0_15px_rgba(51,255,0,0.4)] transform active:scale-95 transition-all duration-200 flex items-center justify-center text-lg">
                    <i class="fas fa-clock mr-2"></i> 开启生命时钟
                </button>
                <button id="share-btn" onclick="copyShareLink()" class="hidden w-full mt-4 text-theme font-semibold py-2 px-6 rounded-xl hover:bg-gray-900 transition-colors flex items-center justify-center border border-[#33ff00] border-dashed">
                     <i class="fas fa-link mr-2"></i> 复制分享链接
                </button>
            </div>

            <!-- Countdown Display Section -->
            <div id="countdown-section" class="hidden flex-col items-center w-full">
                
                <!-- Yearly Progress Bar -->
                <div class="w-full mb-6 group relative">
                    <div class="w-full bg-gray-900 rounded-full h-8 overflow-hidden shadow-inner relative border border-gray-700">
                        <div id="year-progress-bar" class="bg-year-gradient h-full rounded-full transition-all duration-1000 shadow-sm absolute left-0 top-0" style="width: 0%"></div>
                        <!-- Inner Label -->
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 z-10 text-[10px] md:text-xs font-bold text-white/50 tracking-widest uppercase pointer-events-none">
                            2026马年
                        </div>
                        <!-- Center Stats -->
                        <div class="absolute inset-0 flex items-center justify-center z-10 px-4">
                            <span id="year-progress-text" class="text-xs md:text-sm text-white font-bold font-mono tracking-wide whitespace-nowrap text-glow-white">
                                <!-- Populated by JS -->
                            </span>
                        </div>
                    </div>
                </div>

                <!-- This Life (30,000 Days) Bar -->
                <div class="w-full mb-8 group relative">
                    <div class="w-full bg-gray-900 rounded-full h-8 overflow-hidden shadow-inner relative border border-gray-700">
                        <div id="life-30k-bar" class="bg-life-30k-gradient h-full rounded-full transition-all duration-1000 shadow-sm absolute left-0 top-0" style="width: 0%"></div>
                        <!-- Inner Label -->
                        <div class="absolute left-3 top-1/2 -translate-y-1/2 z-10 text-[10px] md:text-xs font-bold text-white/50 tracking-widest uppercase pointer-events-none">
                            人生3万天
                        </div>
                        <!-- Center Stats -->
                        <div class="absolute inset-0 flex items-center justify-center z-10 px-4">
                            <span id="life-30k-text" class="text-xs md:text-sm text-white font-bold font-mono tracking-wide whitespace-nowrap text-glow-white">
                                <!-- Populated by JS -->
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Big Countdown Cards -->
                <div class="grid grid-cols-3 md:grid-cols-5 gap-3 md:gap-6 w-full mb-10">
                     <!-- Years -->
                     <div class="time-card p-3 md:p-4 rounded-2xl text-center">
                        <div class="text-2xl md:text-4xl font-bold text-[#002FA7]" id="years">00</div>
                        <div class="text-theme font-medium mt-1 uppercase text-xs md:text-sm tracking-wider">年</div>
                    </div>
                    <!-- Days -->
                    <div class="time-card p-3 md:p-4 rounded-2xl text-center">
                        <div class="text-2xl md:text-4xl font-bold text-[#008C8C]" id="days">00</div>
                        <div class="text-theme font-medium mt-1 uppercase text-xs md:text-sm tracking-wider">天</div>
                    </div>
                    <!-- Hours -->
                    <div class="time-card p-3 md:p-4 rounded-2xl text-center">
                        <div class="text-2xl md:text-4xl font-bold text-[#F7E14D]" style="text-shadow: 0 1px 1px rgba(0,0,0,0.1);" id="hours">00</div>
                        <div class="text-theme font-medium mt-1 uppercase text-xs md:text-sm tracking-wider">时</div>
                    </div>
                    <!-- Minutes -->
                    <div class="time-card p-3 md:p-4 rounded-2xl text-center">
                        <div class="text-2xl md:text-4xl font-bold text-[#81D8D0]" style="text-shadow: 0 1px 1px rgba(0,0,0,0.1);" id="minutes">00</div>
                        <div class="text-theme font-medium mt-1 uppercase text-xs md:text-sm tracking-wider">分</div>
                    </div>
                    <!-- Seconds -->
                    <div class="time-card p-3 md:p-4 rounded-2xl text-center">
                        <div class="text-2xl md:text-4xl font-bold text-[#FF0000]" id="seconds">00</div>
                        <div class="text-theme font-medium mt-1 uppercase text-xs md:text-sm tracking-wider">秒</div>
                    </div>
                </div>

                <!-- Heart SVG Animation -->
                <div class="w-full mb-8 relative flex justify-center">
                    <div id="heartWrapper" class="heart-wrapper">
                        <!-- SVG Heart -->
                        <svg class="heart-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="fillGradient" x1="0" y1="1" x2="0" y2="0">
                                    <stop id="gradStop1" offset="0%" stop-color="#33ff00" stop-opacity="0.9" />
                                    <stop id="gradStop2" offset="0%" stop-color="#003300" stop-opacity="0.3" />
                                </linearGradient>
                            </defs>
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" 
                                  fill="url(#fillGradient)" 
                                  stroke="#33ff00" 
                                  stroke-width="0.5" 
                                  stroke-linejoin="round"/>
                        </svg>

                        <!-- Text Overlay -->
                        <div class="info-text-container font-tech">
                            <span class="label-text">总30亿次</span>
                            <span id="val-beat" class="beat-number">---,---,---</span>
                            <span id="val-remaining" class="percent-text">余 ---,---,---</span>
                        </div>
                    </div>
                </div>

                <!-- New User Prompt Area -->
                <div class="flex flex-col items-center space-y-4 mb-6">
                    <!-- Create New Button -->
                    <div class="flex items-center space-x-2 bg-gray-900/50 px-4 py-2 rounded-full border border-gray-700">
                        <span class="text-sm text-gray-400">不是 aoao?</span>
                        <button onclick="resetCountdown()" class="text-theme font-bold hover:text-white transition-colors text-sm underline underline-offset-4">
                            创建我的生命倒计时 &rarr;
                        </button>
                    </div>
                    
                    <!-- Reset Button (renamed functionality) -->
                    <!-- Hidden as per new design logic, use the one above instead or keep as fallback -->
                    <button onclick="resetCountdown()" class="hidden text-xs text-gray-500 hover:text-gray-300">
                        [重置信息]
                    </button>
                </div>
                
                 <div class="text-center">
                    <button onclick="copyShareLink()" class="text-theme text-sm hover:underline cursor-pointer opacity-80 hover:opacity-100">
                        分享此生命倒计时
                    </button>
                 </div>
            </div>

            <!-- Completion Overlay -->
            <div id="completion-overlay" class="hidden fixed inset-0 bg-black/95 flex flex-col justify-center items-center z-50">
                <div class="text-4xl md:text-6xl text-[#33ff00] font-bold mb-4 tracking-widest animate-pulse">时间到</div>
                <div class="text-gray-300 mb-8 font-mono">新的旅程开始了。</div>
                <button onclick="resetCountdown()" class="px-6 py-3 border border-[#33ff00] text-[#33ff00] hover:bg-[#33ff00] hover:text-black font-bold rounded transition-colors text-xl">
                    重新开始
                </button>
            </div>

        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-[#33ff00] text-black font-bold px-6 py-3 rounded-full shadow-[0_0_15px_rgba(51,255,0,0.5)] transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        链接已复制！
    </div>

    <script>
        let countdownInterval;
        let pulseInterval; 
        let targetDate; 
        let birthDateTimestamp; 
        let totalBeats = 3000000000;
        let currentRemainingBeats = 0;
        let currentProcessedBeats = 0;

        const CONFIG = {
            heartbeatInterval: 800, 
            randomness: 200
        };

        const yearInput = document.getElementById('year-input');
        const monthInput = document.getElementById('month-input');
        const dayInput = document.getElementById('day-input');
        const yearList = document.getElementById('year-list');
        const monthList = document.getElementById('month-list');
        const dayList = document.getElementById('day-list');

        // Default User Config
        const hostname = window.location.hostname;
        let DEFAULT_USER = {
            name: "aoao",
            dob: "1994-10-10"
        };
        
        if (hostname.includes('emusk.cn') || hostname.includes('musk')) {
            DEFAULT_USER = {
                name: "马斯克",
                dob: "1971-06-28"
            };
        }

        function initSelectors() {
            if(!yearInput) return;
            const currentYear = new Date().getFullYear();
            yearList.innerHTML = '';
            for (let y = currentYear; y >= 1900; y--) {
                const opt = document.createElement('option');
                opt.value = y;
                yearList.appendChild(opt);
            }
            monthList.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const opt = document.createElement('option');
                opt.value = m;
                monthList.appendChild(opt);
            }
            populateDays(31);
            yearInput.addEventListener('input', debounce(updateDayOptions, 500));
            monthInput.addEventListener('input', updateDayOptions);
            yearInput.addEventListener('input', (e) => { if(e.target.value.length === 4) monthInput?.focus(); });
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        function populateDays(count) {
            if(!dayList) return;
            dayList.innerHTML = '';
            for (let d = 1; d <= count; d++) {
                const opt = document.createElement('option');
                opt.value = d;
                dayList.appendChild(opt);
            }
        }

        function updateDayOptions() {
            const y = parseInt(yearInput.value);
            const m = parseInt(monthInput.value);
            if (!y || !m) return;
            const daysInMonth = new Date(y, m, 0).getDate();
            populateDays(daysInMonth);
            if (dayInput && parseInt(dayInput.value) > daysInMonth) dayInput.value = daysInMonth;
        }

        function getSelectedDateString() {
            if(!yearInput || !monthInput || !dayInput) return null;
            const y = parseInt(yearInput.value);
            const m = parseInt(monthInput.value);
            const d = parseInt(dayInput.value);
            if (!y || !m || !d) return null;
            return `${y}-${m.toString().padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
        }

        function setInputsFromDateString(dateStr) {
            try {
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    yearInput.value = parseInt(parts[0]);
                    monthInput.value = parseInt(parts[1]);
                    updateDayOptions();
                    dayInput.value = parseInt(parts[2]);
                    return true;
                }
            } catch(e) {}
            return false;
        }

        function updateSubtitleDate() {
            const subTitle = document.getElementById('sub-title');
            if (subTitle) {
                const now = new Date();
                const dateStr = now.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '.');
                subTitle.innerText = `今天是 ${dateStr}`;
            }
        }

        function toggleHelp() {
            const modal = document.getElementById('help-modal');
            if (modal) {
                modal.classList.toggle('hidden');
            }
        }

        window.addEventListener('load', () => {
            initSelectors();
            updateSubtitleDate();
            
            // Priority 1: URL Params
            const urlParams = new URLSearchParams(window.location.search);
            const paramDob = urlParams.get('dob');
            const paramName = urlParams.get('name');
            const nameInputEl = document.getElementById('name-input');

            if (paramDob && setInputsFromDateString(paramDob)) {
                if (paramName && nameInputEl) nameInputEl.value = decodeURIComponent(paramName);
                startLifeCountdown(true);
                return;
            }

            // Priority 2: Local Storage
            const savedData = localStorage.getItem('lifeCountdownData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.dob && setInputsFromDateString(data.dob)) {
                        if(nameInputEl) nameInputEl.value = data.name || "";
                        startLifeCountdown(true);
                        return;
                    }
                } catch(e) {}
            }

            // Priority 3: Default "aoao" (Demo Mode)
            // No saved data found, load default
            if (nameInputEl) nameInputEl.value = DEFAULT_USER.name;
            setInputsFromDateString(DEFAULT_USER.dob);
            startLifeCountdown(true); 
            // Note: We do NOT save this to localStorage so the user is prompted next time too unless they save their own.
        });

        function startLifeCountdown(isRestoring = false) {
            const nameInput = document.getElementById('name-input');
            const userName = nameInput ? (nameInput.value.trim() || "旅行者") : "旅行者";
            const dobValue = getSelectedDateString();
            
            if (!dobValue) { if (!isRestoring) alert("请输入有效的出生日期"); return; }

            const dob = new Date(dobValue);
            birthDateTimestamp = dob.getTime();
            
            const eightyYearsDate = new Date(dobValue);
            eightyYearsDate.setFullYear(dob.getFullYear() + 80);
            targetDate = eightyYearsDate.getTime();

            if (birthDateTimestamp > new Date().getTime()) {
                if(!isRestoring) alert("出生日期不能是未来！");
                return;
            }

            // Only save if it's NOT the default user to avoid overwriting user preference with default on logic errors
            // Or save everything if the user explicitly clicked "Start" (isRestoring = false)
            if (!isRestoring || (userName !== DEFAULT_USER.name)) {
                 try { localStorage.setItem('lifeCountdownData', JSON.stringify({ name: userName, dob: dobValue })); } catch(e) {}
            }

            document.getElementById('setup-section').classList.add('hidden');
            const countdownSection = document.getElementById('countdown-section');
            countdownSection.classList.remove('hidden');
            countdownSection.classList.add('flex');
            
            document.getElementById('main-title').innerHTML = `${userName} 生命倒计时`;

            calculateInitialBeats();
            updateTimer();
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(updateTimer, 1000);

            startPulseLoop();
        }

        function calculateInitialBeats() {
            const totalLifeSpan = targetDate - birthDateTimestamp;
            const now = new Date().getTime();
            const timeLeft = targetDate - now;
            if (timeLeft <= 0) currentRemainingBeats = 0;
            else {
                const ratio = timeLeft / totalLifeSpan;
                currentRemainingBeats = Math.floor(totalBeats * ratio);
            }
            currentProcessedBeats = totalBeats - currentRemainingBeats;
            updateBeatsDisplay();
        }

        function updateBeatsDisplay() {
            const pct = (currentProcessedBeats / totalBeats) * 100;
            
            const valBeat = document.getElementById('val-beat');
            const valRemaining = document.getElementById('val-remaining');
            const gradStop1 = document.getElementById('gradStop1');
            const gradStop2 = document.getElementById('gradStop2');

            if(valBeat) valBeat.innerText = currentProcessedBeats.toLocaleString();
            if(valRemaining) valRemaining.innerText = "余 " + currentRemainingBeats.toLocaleString();
            
            if(gradStop1 && gradStop2) {
                gradStop1.setAttribute('offset', pct + "%");
                gradStop2.setAttribute('offset', pct + "%");
            }
        }

        function updateTimer() {
            const now = new Date();
            const nowTime = now.getTime();
            const distance = targetDate - nowTime;

            // 1. Yearly
            const currentYear = now.getFullYear();
            const startOfYear = new Date(currentYear, 0, 1);
            const endOfYear = new Date(currentYear + 1, 0, 1);
            const totalYearMillis = endOfYear - startOfYear;
            const elapsedYearMillis = now - startOfYear;
            let yearPercentage = (elapsedYearMillis / totalYearMillis) * 100;
            if (yearPercentage > 100) yearPercentage = 100;
            const daysLeftInYear = Math.floor((endOfYear - now) / (1000 * 60 * 60 * 24));
            
            const daysPassedInYear = Math.floor((now - startOfYear) / (1000 * 60 * 60 * 24));
            const yearRemPercent = (100 - yearPercentage).toFixed(1);

            const yearProgressText = document.getElementById('year-progress-text');
            const yearProgressBar = document.getElementById('year-progress-bar');
            
            if(yearProgressText) yearProgressText.innerText = `今年已过 ${daysPassedInYear}天· ${yearPercentage.toFixed(1)}% | 剩 ${daysLeftInYear}天· ${yearRemPercent}%`;
            if(yearProgressBar) yearProgressBar.style.width = `${yearPercentage}%`;

            // 2. This Life (30,000 Days)
            const msPerDay = 1000 * 60 * 60 * 24;
            const daysLived = Math.floor((nowTime - birthDateTimestamp) / msPerDay);
            const totalLifeDays = 30000;
            const daysLeft30k = totalLifeDays - daysLived;
            let life30kPercent = (daysLived / totalLifeDays) * 100;
            if (life30kPercent > 100) life30kPercent = 100; if (life30kPercent < 0) life30kPercent = 0;
            
            const life30kRemPercent = (100 - life30kPercent).toFixed(0); 

            const elLife30kBar = document.getElementById('life-30k-bar');
            const elLife30kText = document.getElementById('life-30k-text');
            
            if (elLife30kText) elLife30kText.innerText = `今生已过 ${daysLived}天· ${life30kPercent.toFixed(0)}% | 剩 ${daysLeft30k}天· ${life30kRemPercent}%`;
            if (elLife30kBar) elLife30kBar.style.width = `${life30kPercent}%`;

            // 3. Countdown
            if (distance < 0) {
                document.getElementById('completion-overlay').classList.remove('hidden');
                return;
            }

            const msPerYear = 1000 * 60 * 60 * 24 * 365.25;
            let remaining = distance;
            const years = Math.floor(remaining / msPerYear); remaining %= msPerYear;
            const days = Math.floor(remaining / (1000 * 60 * 60 * 24)); remaining %= (1000 * 60 * 60 * 24);
            const hours = Math.floor(remaining / (1000 * 60 * 60)); remaining %= (1000 * 60 * 60);
            const minutes = Math.floor(remaining / (1000 * 60)); remaining %= (1000 * 60);
            const seconds = Math.floor(remaining / 1000);

            const elYears = document.getElementById('years');
            const elDays = document.getElementById('days');
            const elHours = document.getElementById('hours');
            const elMinutes = document.getElementById('minutes');
            const elSeconds = document.getElementById('seconds');

            if(elYears) elYears.innerText = years;
            if(elDays) elDays.innerText = days;
            if(elHours) elHours.innerText = hours < 10 ? '0' + hours : hours;
            if(elMinutes) elMinutes.innerText = minutes < 10 ? '0' + minutes : minutes;
            if(elSeconds) elSeconds.innerText = seconds < 10 ? '0' + seconds : seconds;
        }

        function startPulseLoop() {
            triggerPulse();
            const nextTime = CONFIG.heartbeatInterval + (Math.random() * CONFIG.randomness);
            pulseInterval = setTimeout(startPulseLoop, nextTime);
        }

        function triggerPulse() {
            if (currentRemainingBeats > 0) {
                currentRemainingBeats--;
                currentProcessedBeats++;
                updateBeatsDisplay();
            }

            const heartWrapper = document.getElementById('heartWrapper');
            if(heartWrapper) {
                heartWrapper.classList.remove('pulse-active');
                void heartWrapper.offsetWidth; 
                heartWrapper.classList.add('pulse-active');
            }

            const lifeBarContainer = document.getElementById('life-bar-container');
            if(lifeBarContainer) {
                lifeBarContainer.classList.remove('pulse-active');
                void lifeBarContainer.offsetWidth; 
                lifeBarContainer.classList.add('pulse-active');
            }

            const lifeProgressBar = document.getElementById('life-progress-bar');
            if(lifeProgressBar) {
                const pct = (currentProcessedBeats / totalBeats) * 100;
                lifeProgressBar.style.width = `${pct}%`;
            }
        }

        function resetCountdown() {
            clearInterval(countdownInterval);
            clearTimeout(pulseInterval);
            
            // Clear URL params without refreshing
            const url = new URL(window.location);
            url.search = '';
            window.history.pushState({}, '', url);

            document.getElementById('setup-section').classList.remove('hidden');
            document.getElementById('countdown-section').classList.add('hidden');
            document.getElementById('countdown-section').classList.remove('flex');
            document.getElementById('share-btn').classList.add('hidden');
            document.getElementById('completion-overlay').classList.add('hidden');
            
            document.getElementById('main-title').innerHTML = `生命倒计时`;
            updateSubtitleDate();

            yearInput.value = ""; monthInput.value = ""; dayInput.value = ""; 
            const nameEl = document.getElementById('name-input');
            if(nameEl) nameEl.value = "";
            
            document.title = "生命倒计时 | Life Countdown";
        }

        function copyShareLink() {
            const nameInput = document.getElementById('name-input');
            const dobValue = getSelectedDateString();
            const nameValue = nameInput ? nameInput.value : "";
            
            if (!dobValue) return;

            const baseUrl = window.location.href.split('?')[0];
            const fullUrl = `${baseUrl}?dob=${encodeURIComponent(dobValue)}&name=${encodeURIComponent(nameValue)}`;
            
            const textArea = document.createElement("textarea");
            textArea.value = fullUrl;
            document.body.appendChild(textArea);
            textArea.select();
            try { document.execCommand('copy'); showToast(); } catch (e) {}
            document.body.removeChild(textArea);
        }

        function showToast() {
            const toast = document.getElementById('toast');
            if(toast) {
                toast.style.opacity = '1';
                setTimeout(() => { toast.style.opacity = '0'; }, 2000);
            }
        }

        function goHome(e) {
            e.preventDefault();
            let host = window.location.hostname;
            
            // Logic: If starts with 't.', remove it. 
            // e.g., t.aoao.life -> aoao.life
            if (host.startsWith('t.')) {
                host = host.substring(2);
            } 
            // Fallback for localhost or IP
            else if (host === '127.0.0.1' || host === 'localhost') {
                host = 'aoao.life';
            }
            
            window.location.href = 'https://' + host;
        }
    </script>
</body>
</html>